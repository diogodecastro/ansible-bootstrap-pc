---
- name: Verificando a existência de túnel Proxy SSH
  shell: ps -ef | grep -iE -- "ss[h].*{{vpn_redhat_proxy_port}}" | awk '{print $2}'
  register: proxy_pids
  become: yes 

- name: Criando túnel Proxy SSH
  shell: |
    set +H
    nohup sshpass -p {{vpn_redhat_pass}} ssh -D {{vpn_redhat_proxy_port}} {{vpn_redhat_user}}@{{vpn_redhat_ssh_url}} -p {{vpn_redhat_ssh_port}} -N -oStrictHostKeyChecking=no &
    sleep 5
  become: yes
  when: proxy_pids.stdout == ""

- name: Redirecionando a URL interna para o Proxy SSH
  shell: nc -z home.corp.redhat.com 80 -w2 --proxy localhost:{{vpn_redhat_proxy_port}} --proxy-type socks5
  become: yes

- name: Instalando o Certificados e Pacotes da VPN Red Hat
  shell: |
    http_proxy=socks5h://localhost:{{vpn_redhat_proxy_port}} rpm --import http://hdn.corp.redhat.com/rhel7-csb-stage/RPM-GPG-KEY-helpdesk
    http_proxy=socks5h://localhost:{{vpn_redhat_proxy_port}} curl -o /etc/yum.repos.d/rhel7-csb-stage.repo http://hdn.corp.redhat.com/rhel7-csb-stage/rhel7-csb-stage.repo
    http_proxy=socks5h://localhost:{{vpn_redhat_proxy_port}} dnf install -y redhat-internal-cert-install redhat-internal-NetworkManager-openvpn-profiles
  become: yes

- name: Parando o serviço de túnel Proxy SSH
  shell: ps -ef | grep -iE -- "ss[h].*{{vpn_redhat_proxy_port}}" | awk '{print $2}' | xargs kill -9
  become: yes

- name: Removendo o repositório da VPN
  shell: rm /etc/yum.repos.d/rhel7-csb-stage.repo
  become: yes